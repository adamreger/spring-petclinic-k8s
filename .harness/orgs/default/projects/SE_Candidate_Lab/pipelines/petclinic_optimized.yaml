pipeline:
  name: petclinic-optimized
  identifier: petclinic_optimized
  projectIdentifier: SE_Candidate_Lab
  orgIdentifier: default
  tags: {}
  properties:
    ci:
      codebase:
        connectorRef: github_petclinic
        repoName: adamreger/spring-petclinic-k8s
        build: <+input>
  variables:
    - name: DEPLOY_ENV
      type: String
      value: <+input>.default(dev).selectOneFrom(dev,stg,prd)
    - name: SKIP_DEPCHECK
      type: String
      value: <+input>.default(false).selectOneFrom(true,false)
    - name: SKIP_BUILD_TEST
      type: String
      value: <+input>.default(false).selectOneFrom(true,false)
    - name: CANARY_POD_COUNT
      type: Number
      value: <+input>.default(1)
  stages:
    - stage:
        name: Build and Package
        identifier: build_package
        type: CI
        spec:
          cloneCodebase: true
          infrastructure:
            type: KubernetesDirect
            spec:
              connectorRef: k8s_docker_desktop
              namespace: harness-delegate-ng
              automountServiceAccountToken: true
              nodeSelector: {}
              os: Linux
          execution:
            steps:
              - step:
                  type: Run
                  name: Maven Build All Modules
                  identifier: mvn_build_all
                  strategy:
                    matrix:
                      module:
                        - spring-petclinic-api-gateway
                        - spring-petclinic-customers-service
                        - spring-petclinic-vets-service
                        - spring-petclinic-visits-service
                  spec:
                    connectorRef: dockerhub_petclinic
                    image: maven:3.9.6-eclipse-temurin-8
                    shell: Sh
                    envVariables:
                      MODULE: <+matrix.module>
                    command: |
                      unset MAVEN_CONFIG
                      chmod +x mvnw
                      export MAVEN_OPTS="-Xmx2g"
                      mkdir -p /harness/.m2/repository

                      echo "Building module: $MODULE"
                      ./mvnw -B -pl "$MODULE" -am clean package -DskipTests \
                        -Dmaven.repo.local=/harness/.m2/repository

                      # Verify JAR was created
                      echo "=== Built JAR for $MODULE ==="
                      find ${MODULE}/target -name "*.jar" -type f | head -5
              - step:
                  type: Run
                  name: Prepare Artifacts
                  identifier: prepare_artifacts
                  spec:
                    connectorRef: dockerhub_petclinic
                    image: alpine:3.18
                    shell: Sh
                    command: |
                      echo "=== Organizing artifacts for caching ==="

                      # Create artifacts directory at a known location
                      mkdir -p /harness/artifacts

                      # Copy JARs with standardized naming
                      echo "Collecting JARs..."

                      cp spring-petclinic-api-gateway/target/*.jar /harness/artifacts/api-gateway.jar 2>/dev/null || echo "Warning: Gateway JAR not found"
                      cp spring-petclinic-customers-service/target/*.jar /harness/artifacts/customers-service.jar 2>/dev/null || echo "Warning: Customers JAR not found"
                      cp spring-petclinic-vets-service/target/*.jar /harness/artifacts/vets-service.jar 2>/dev/null || echo "Warning: Vets JAR not found"
                      cp spring-petclinic-visits-service/target/*.jar /harness/artifacts/visits-service.jar 2>/dev/null || echo "Warning: Visits JAR not found"

                      # Display collected artifacts
                      echo ""
                      echo "=== Artifacts ready for caching ==="
                      ls -lh /harness/artifacts/
                      echo ""
                      echo "Total size: $(du -sh /harness/artifacts/ | cut -f1)"
          caching:
            enabled: true
            paths:
              - /harness/.m2/repository
              - /harness/artifacts
          buildIntelligence:
            enabled: false
        description: Build all JAR artifacts once and cache them
    - stage:
        name: Security and Quality Checks
        identifier: security_quality
        description: Run security scans and tests on built artifacts
        type: CI
        spec:
          cloneCodebase: true
          infrastructure:
            useFromStage: build_package
          execution:
            steps:
              - step:
                  type: Run
                  name: Verify Cached Artifacts
                  identifier: verify_artifacts
                  spec:
                    connectorRef: dockerhub_petclinic
                    image: alpine:3.18
                    shell: Sh
                    command: |
                      echo "=== Verifying cached artifacts ==="
                      if [ -d /harness/artifacts ]; then
                        ls -lh /harness/artifacts/
                        echo ""
                        echo "✓ All artifacts restored automatically by Harness Cache Intelligence"
                      else
                        echo "✗ Artifacts directory not found!"
                        exit 1
                      fi
              - step:
                  type: Run
                  name: OWASP Dependency Check
                  identifier: owasp_dependency_check
                  when:
                    stageStatus: Success
                    condition: |
                      <+pipeline.variables.SKIP_DEPCHECK> == "false" || <+pipeline.variables.DEPLOY_ENV> == "stg" || <+pipeline.variables.DEPLOY_ENV> == "prd"
                  spec:
                    connectorRef: dockerhub_petclinic
                    image: owasp/dependency-check:12.0.2
                    shell: Sh
                    command: |-
                      echo "=== Running OWASP Dependency Check on cached artifacts ==="

                      DC_BIN="/usr/share/dependency-check/bin/dependency-check.sh"
                      DC_DATA_DIR="/harness/.dependency-check-data"
                      REPORT_DIR="/harness/dependency-check-report"

                      if [ ! -x "${DC_BIN}" ]; then
                        echo "✗ Dependency-Check CLI is missing in the container image."
                        exit 1
                      fi

                      if [ ! -d /harness/artifacts ]; then
                        echo "✗ Cached artifacts directory not found at /harness/artifacts"
                        exit 1
                      fi

                      mkdir -p "${DC_DATA_DIR}" "${REPORT_DIR}"
                      DC_DB_PRESENT=$(find "${DC_DATA_DIR}" -maxdepth 1 -name "nvdcve*.mv.db" -print -quit)

                      if [ -z "${DC_DB_PRESENT}" ]; then
                        echo "No cached vulnerability database found; allowing Dependency-Check to download the latest feeds..."
                        echo "This may add a few minutes to the first scan."
                      else
                        echo "Reusing cached vulnerability database (noupdate mode)."
                      fi

                      echo "Scanning cached JAR artifacts..."

                      set -- \
                        --project "spring-petclinic" \
                        --scan "/harness/artifacts" \
                        --out "${REPORT_DIR}" \
                        --data "${DC_DATA_DIR}" \
                        --format "HTML" \
                        --format "JSON" \
                        --format "XML" \
                        --failOnCVSS 11

                      if [ -n "${NVD_API_KEY}" ]; then
                        set -- "$@" --nvdApiKey "${NVD_API_KEY}"
                      fi

                      if [ -n "${DC_DB_PRESENT}" ]; then
                        set -- "$@" --noupdate
                      fi

                      "${DC_BIN}" "$@"

                      echo "✓ Dependency-Check completed"
                      echo "Reports available at: ${REPORT_DIR}/"
                    resources:
                      limits:
                        memory: 4Gi
                        cpu: "2"
                    envVariables:
                      JAVA_TOOL_OPTIONS: "-Xms512m -Xmx4096m"
                      NVD_API_KEY: <+secrets.getValue("NVD_API_KEY")>
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
              - step:
                  type: RunTests
                  name: Unit Tests
                  identifier: unit_tests
                  when:
                    stageStatus: Success
                    condition: <+pipeline.variables.SKIP_BUILD_TEST> == "false" || <+pipeline.variables.DEPLOY_ENV> == "stg" ||  <+pipeline.variables.DEPLOY_ENV> == "prd"
                  spec:
                    connectorRef: dockerhub_petclinic
                    image: maven:3.9.6-eclipse-temurin-8
                    language: Java
                    buildTool: Maven
                    args: test
                    runOnlySelectedTests: false
                    preCommand: |
                      echo "Running tests with cached dependencies"
                    reports:
                      type: JUnit
                      spec:
                        paths:
                          - "**/target/surefire-reports/*.xml"
                    resources:
                      limits:
                        memory: 4Gi
                        cpu: "2"
                    envVariables:
                      MAVEN_OPTS: "-Xms512m"
                      NVD_API_KEY: <+secrets.getValue("NVD_API_KEY")>
                    enableTestSplitting: false
                  failureStrategies:
                    - onFailure:
                        errors:
                          - AllErrors
                        action:
                          type: Ignore
          caching:
            enabled: true
            paths:
              - /harness/.m2/repository
              - /harness/artifacts
          buildIntelligence:
            enabled: false
    - stage:
        name: Build and Push Container Images
        identifier: build_push_images
        description: Build Docker images from cached JAR artifacts
        type: CI
        spec:
          cloneCodebase: true
          infrastructure:
            type: KubernetesDirect
            spec:
              connectorRef: k8s_docker_desktop
              namespace: harness-delegate-ng
              automountServiceAccountToken: true
              nodeSelector: {}
              os: Linux
          execution:
            steps:
              - step:
                  type: Run
                  name: Verify Artifacts for Docker Build
                  identifier: verify_artifacts_docker
                  spec:
                    connectorRef: dockerhub_petclinic
                    image: alpine:3.18
                    shell: Sh
                    command: |
                      echo "=== Verifying artifacts for Docker builds ==="
                      ls -lh /harness/artifacts/

                      # Verify each required JAR exists
                      for jar in api-gateway.jar customers-service.jar vets-service.jar visits-service.jar; do
                        if [ -f "/harness/artifacts/${jar}" ]; then
                          echo "✓ ${jar} found ($(du -h /harness/artifacts/${jar} | cut -f1))"
                        else
                          echo "✗ ${jar} NOT FOUND!"
                          exit 1
                        fi
                      done

                      echo ""
                      echo "✓ All artifacts restored automatically by Harness Cache Intelligence"
              - stepGroup:
                  name: Build All Images
                  identifier: Build_All_Images
                  steps:
                    - step:
                        type: BuildAndPushDockerRegistry
                        name: API Gateway Image
                        identifier: build_push_gateway
                        spec:
                          connectorRef: dockerhub_push
                          repo: areger55/harness-se-lab-dockerhub-repo
                          tags:
                            - gateway-<+codebase.commitSha>
                            - gateway-latest
                          context: /harness
                          dockerfile: /harness/Optimized.Dockerfile
                          caching: true
                          buildArgs:
                            JAR_FILE: artifacts/api-gateway.jar
                          resources:
                            limits:
                              memory: 2Gi
                              cpu: "1"
                    - step:
                        type: BuildAndPushDockerRegistry
                        name: Customers Image
                        identifier: build_push_customers
                        spec:
                          connectorRef: dockerhub_push
                          repo: areger55/harness-se-lab-dockerhub-repo
                          tags:
                            - customers-<+codebase.commitSha>
                            - customers-latest
                          context: /harness
                          dockerfile: /harness/Optimized.Dockerfile
                          caching: true
                          buildArgs:
                            JAR_FILE: artifacts/customers-service.jar
                          resources:
                            limits:
                              memory: 2Gi
                              cpu: "1"
                    - step:
                        type: BuildAndPushDockerRegistry
                        name: Vets Image
                        identifier: build_push_vets
                        spec:
                          connectorRef: dockerhub_push
                          repo: areger55/harness-se-lab-dockerhub-repo
                          tags:
                            - vets-<+codebase.commitSha>
                            - vets-latest
                          context: /harness
                          dockerfile: /harness/Optimized.Dockerfile
                          caching: true
                          buildArgs:
                            JAR_FILE: artifacts/vets-service.jar
                          resources:
                            limits:
                              memory: 2Gi
                              cpu: "1"
                    - step:
                        type: BuildAndPushDockerRegistry
                        name: Visits Image
                        identifier: build_push_visits
                        spec:
                          connectorRef: dockerhub_push
                          repo: areger55/harness-se-lab-dockerhub-repo
                          tags:
                            - visits-<+codebase.commitSha>
                            - visits-latest
                          context: /harness
                          dockerfile: /harness/Optimized.Dockerfile
                          caching: true
                          buildArgs:
                            JAR_FILE: artifacts/visits-service.jar
                          resources:
                            limits:
                              memory: 2Gi
                              cpu: "1"
          caching:
            enabled: true
            paths:
              - /harness/artifacts
          buildIntelligence:
            enabled: true
    - parallel:
        - stage:
            name: Deploy Customers
            identifier: deploy_customers
            tags: {}
            template:
              templateRef: K8s_Canary_Deploy_v2
              versionLabel: v1
              templateInputs:
                type: Deployment
                variables:
                  - name: envRef
                    type: String
                    value: <+pipeline.variables.DEPLOY_ENV>
                  - name: serviceName
                    type: String
                    value: customersservice
                  - name: appName
                    type: String
                    value: customers
                  - name: canaryCount
                    type: Number
                    value: <+pipeline.variables.CANARY_POD_COUNT>
        - stage:
            name: Deploy Vets
            identifier: deploy_vets
            tags: {}
            template:
              templateRef: K8s_Canary_Deploy_v2
              versionLabel: v1
              templateInputs:
                type: Deployment
                variables:
                  - name: envRef
                    type: String
                    value: <+pipeline.variables.DEPLOY_ENV>
                  - name: serviceName
                    type: String
                    value: vetsservice
                  - name: appName
                    type: String
                    value: vets
                  - name: canaryCount
                    type: Number
                    value: <+pipeline.variables.CANARY_POD_COUNT>
        - stage:
            name: Deploy Visits
            identifier: deploy_visits
            tags: {}
            template:
              templateRef: K8s_Canary_Deploy_v2
              versionLabel: v1
              templateInputs:
                type: Deployment
                variables:
                  - name: envRef
                    type: String
                    value: <+pipeline.variables.DEPLOY_ENV>
                  - name: serviceName
                    type: String
                    value: visitsservice
                  - name: appName
                    type: String
                    value: visits
                  - name: canaryCount
                    type: Number
                    value: <+pipeline.variables.CANARY_POD_COUNT>
        - stage:
            name: Deploy Gateway
            identifier: deploy_gateway
            tags: {}
            template:
              templateRef: K8s_Canary_Deploy_v2
              versionLabel: v1
              templateInputs:
                type: Deployment
                variables:
                  - name: envRef
                    type: String
                    value: <+pipeline.variables.DEPLOY_ENV>
                  - name: serviceName
                    type: String
                    value: apigatewayservice
                  - name: appName
                    type: String
                    value: gateway
                  - name: canaryCount
                    type: Number
                    value: <+pipeline.variables.CANARY_POD_COUNT>
