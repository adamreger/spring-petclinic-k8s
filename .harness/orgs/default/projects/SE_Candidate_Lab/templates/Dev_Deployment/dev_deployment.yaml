template:
  name: Dev Deployment
  type: Stage
  projectIdentifier: SE_Candidate_Lab
  orgIdentifier: default
  spec:
    type: Deployment
    spec:
      deploymentType: Kubernetes
      service:
        serviceRef: apigatewayservice
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: PipelineRollback
      environment:
        environmentRef: dev
        deployToAll: false
        infrastructureDefinitions:
          - identifier: harnessk8sinfradev
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: PipelineRollback
      execution:
        steps:
          - stepGroup:
              name: Canary Deployment
              identifier: canaryDeployment
              steps:
                - step:
                    name: Canary Deployment
                    identifier: canaryDeployment
                    type: K8sCanaryDeploy
                    timeout: 10m
                    spec:
                      instanceSelection:
                        type: Count
                        spec:
                          count: <+pipeline.variables.CANARY_POD_COUNT>
                      skipDryRun: false
                - step:
                    name: Observe Canary
                    identifier: observeCanary
                    type: Wait
                    timeout: 10m
                    spec:
                      duration: 1m
                - step:
                    name: Check Canary Health
                    identifier: checkCanaryHealth
                    type: ShellScript
                    timeout: 10m
                    spec:
                      shell: Bash
                      onDelegate: true
                      source:
                        type: Inline
                        spec:
                          script: |
                            set -euo pipefail
                            echo "Checking canary rollout status..."
                            status=0
                            if ! kubectl rollout status deployment/api-gateway-canary --namespace petclinic --timeout=180s; then
                              status=$?
                              echo "Canary deployment did not become ready within timeout (exit code ${status})."
                            fi
                            selector=""
                            release_label=$(kubectl get deployment/api-gateway-canary --namespace petclinic -o jsonpath='{.metadata.labels.harness\.io/release-name}' 2>/dev/null || true)
                            if [ -n "${release_label}" ]; then
                              selector="harness.io/release-name=${release_label}"
                            else
                              selector=$(kubectl get deployment/api-gateway-canary --namespace petclinic -o jsonpath='{range $k,$v := .spec.selector.matchLabels}{$k}={$v},{end}' 2>/dev/null || true)
                              selector="${selector%,}"
                            fi

                            if [ -z "${selector}" ]; then
                              echo "Unable to determine a label selector for api-gateway-canary; skipping pod listing and log collection."
                            else
                              echo "Listing canary pods for quick inspection (selector: ${selector}):"
                              kubectl get pods --namespace petclinic -l "${selector}" -o wide || true
                              echo "Fetching recent logs from canary pod(s) for diagnostics..."
                              mapfile -t pods < <(kubectl get pods --namespace petclinic -l "${selector}" -o name)
                              if [ ${#pods[@]} -eq 0 ]; then
                                echo "No canary pods found to fetch logs from."
                              else
                                for pod in "${pods[@]}"; do
                                  echo "----- Logs for ${pod} -----"
                                  kubectl logs --namespace petclinic "${pod}" --tail=200 || true
                                  echo "----- End logs for ${pod} -----"
                                done
                              fi
                            fi
                            exit ${status}
                      environmentVariables: []
                      outputVariables: []
                - step:
                    name: Canary Delete
                    identifier: canaryDelete
                    type: K8sCanaryDelete
                    timeout: 10m
                    spec: {}
          - stepGroup:
              name: Primary Deployment
              identifier: primaryDeployment
              steps:
                - step:
                    name: Rolling Deployment
                    identifier: rollingDeployment
                    type: K8sRollingDeploy
                    timeout: 10m
                    spec:
                      skipDryRun: false
        rollbackSteps:
          - step:
              name: Canary Delete
              identifier: rollbackCanaryDelete
              type: K8sCanaryDelete
              timeout: 10m
              spec: {}
          - step:
              name: Rolling Rollback
              identifier: rollingRollback
              type: K8sRollingRollback
              timeout: 10m
              spec: {}
    failureStrategies:
      - onFailure:
          errors:
            - AllErrors
          action:
            type: StageRollback
  identifier: Dev_Deployment
  versionLabel: v_1.0.0
