template:
  name: Dev Deployment
  type: Stage
  projectIdentifier: SE_Candidate_Lab
  orgIdentifier: default
  spec:
    type: Deployment
    spec:
      deploymentType: Kubernetes
      service:
        serviceRef: apigatewayservice
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: PipelineRollback
      environment:
        environmentRef: dev
        deployToAll: false
        infrastructureDefinitions:
          - identifier: harnessk8sinfradev
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: PipelineRollback
      execution:
        steps:
          - stepGroup:
              name: Canary Deployment
              identifier: canaryDeployment
              steps:
                - step:
                    name: Canary Deployment
                    identifier: canaryDeployment
                    type: K8sCanaryDeploy
                    timeout: 10m
                    spec:
                      instanceSelection:
                        type: Count
                        spec:
                          count: <+pipeline.variables.CANARY_POD_COUNT>
                      skipDryRun: false
                - step:
                    name: Observe Canary
                    identifier: observeCanary
                    type: Wait
                    timeout: 10m
                    spec:
                      duration: 1m
                - step:
                    name: Check Canary Health
                    identifier: checkCanaryHealth
                    type: ShellScript
                    timeout: 10m
                    spec:
                      shell: Bash
                      onDelegate: true
                      source:
                        type: Inline
                        spec:
                          script: |
                            set -euo pipefail
                            echo "Checking canary rollout status..."
                            status=0
                            if ! kubectl rollout status deployment/api-gateway-canary --namespace petclinic --timeout=180s; then
                              status=$?
                              echo "Canary deployment did not become ready within timeout (exit code ${status})."
                            fi
                            echo "Listing canary pods for quick inspection:"
                            kubectl get pods --namespace petclinic -l harness.io/canary=true -o wide
                            echo "Fetching recent logs from canary pod(s) for diagnostics..."
                            mapfile -t pods < <(kubectl get pods --namespace petclinic -l harness.io/canary=true -o name)
                            if [ ${#pods[@]} -eq 0 ]; then
                              echo "No canary pods found to fetch logs from."
                            else
                              for pod in "${pods[@]}"; do
                                echo "----- Logs for ${pod} -----"
                                kubectl logs --namespace petclinic "${pod}" --tail=200 || true
                                echo "----- End logs for ${pod} -----"
                              done
                            fi
                            exit ${status}
                      environmentVariables: []
                      outputVariables: []
                - step:
                    name: Canary Delete
                    identifier: canaryDelete
                    type: K8sCanaryDelete
                    timeout: 10m
                    spec: {}
          - stepGroup:
              name: Primary Deployment
              identifier: primaryDeployment
              steps:
                - step:
                    name: Rolling Deployment
                    identifier: rollingDeployment
                    type: K8sRollingDeploy
                    timeout: 10m
                    spec:
                      skipDryRun: false
        rollbackSteps:
          - step:
              name: Canary Delete
              identifier: rollbackCanaryDelete
              type: K8sCanaryDelete
              timeout: 10m
              spec: {}
          - step:
              name: Rolling Rollback
              identifier: rollingRollback
              type: K8sRollingRollback
              timeout: 10m
              spec: {}
    failureStrategies:
      - onFailure:
          errors:
            - AllErrors
          action:
            type: StageRollback
  identifier: Dev_Deployment
  versionLabel: v_1.0.0
