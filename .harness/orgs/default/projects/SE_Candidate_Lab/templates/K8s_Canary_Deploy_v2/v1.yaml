template:
  name: K8s Canary Deploy v2
  type: Stage
  projectIdentifier: SE_Candidate_Lab
  orgIdentifier: default
  spec:
    type: Deployment
    spec:
      deploymentType: Kubernetes
      service:
        serviceRef: <+stage.variables.serviceName>
        failureStrategies: []
      environment:
        environmentRef: <+stage.variables.envRef>
        deployToAll: false
        infrastructureDefinitions:
          - identifier: k8s_infra_<+stage.variables.envRef>
      execution:
        steps:
          - stepGroup:
              name: K8s Canary Deploy
              identifier: K8s_Canary_Deploy
              steps:
                - step:
                    type: HarnessApproval
                    name: Pre-Deploy Approval
                    identifier: PreDeploy_Approval
                    spec:
                      approvalMessage: Approve deploying <+stage.variables.serviceName> to <+stage.variables.envRef>?
                      includePipelineExecutionHistory: true
                      isAutoRejectEnabled: false
                      approvers:
                        userGroups:
                          - org._ORG_PROD_DEPLOYERS_
                          - org._ORG_SRE_ONCALL_
                        minimumCount: 1
                        disallowPipelineExecutor: false
                      approverInputs: []
                    timeout: 1h
                    when:
                      stageStatus: Success
                      condition: <+pipeline.variables.DEPLOY_ENV> == "prd"
                    approvalCriteria:
                      type: Criteria
                      spec:
                        conditions:
                          - type: APPROVAL_CONDITION
                            spec:
                              comparator: EQ
                              fieldName: HarnessApproval
                              value: "true"
                - step:
                    type: K8sCanaryDeploy
                    name: Canary Deployment
                    identifier: Canary_Deployment
                    spec:
                      skipDryRun: false
                      instanceSelection:
                        type: Count
                        spec:
                          count: <+stage.variables.canaryCount>
                      skipUnchangedManifest: true
                    timeout: 3m
                    failureStrategies:
                      - onFailure:
                          errors:
                            - AllErrors
                          action:
                            type: MarkAsFailure
                - step:
                    type: ShellScript
                    name: Check Canary Health
                    identifier: Check_Canary_Health
                    spec:
                      shell: Bash
                      executionTarget: {}
                      source:
                        type: Inline
                        spec:
                          script: |
                            set -euo pipefail
                            ns="<+infra.namespace>"
                            app="<+stage.variables.appName>"

                            echo "Checking rollout for ${app}-canary in ${ns}..."
                            status=0

                            if ! kubectl rollout status "deployment/${app}-canary" --namespace "${ns}" --timeout=120s; then
                              status=$?
                              echo "Canary deployment did not become ready within timeout (exit ${status})."
                            fi

                            selector="harness.io/track=canary"
                            release_label=$(kubectl get deployment "${app}-canary" --namespace "${ns}" -o jsonpath='{.spec.template.metadata.labels.harness\.io/release-name}' 2>/dev/null || true)
                            if [ -n "${release_label}" ]; then
                              selector+=",harness.io/release-name=${release_label}"
                            else
                              echo "Harness release label not found on pod template; selector will rely on track label only."
                            fi

                            if [ -z "${selector}" ]; then
                              echo "Unable to determine a label selector for ${app}-canary; skipping pod listing and log collection."
                            else
                              echo "Listing canary pods for quick inspection (selector: ${selector}):"
                              kubectl get pods --namespace "${ns}" -l "${selector}" -o wide || true

                              echo "Fetching recent logs from canary pod(s) for diagnostics..."
                              mapfile -t pods < <(kubectl get pods --namespace "${ns}" -l "${selector}" -o name)
                              if [ ${#pods[@]} -eq 0 ]; then
                                echo "No canary pods found to fetch logs from."
                              else
                                for pod in "${pods[@]}"; do
                                  echo "----- Logs for ${pod} -----"
                                  kubectl logs --namespace "${ns}" "${pod}" --tail=200 || true
                                  echo "----- End logs for ${pod} -----"
                                done
                              fi
                            fi

                            exit ${status}
                      environmentVariables: []
                      outputVariables: []
                    timeout: 2m
                    failureStrategies:
                      - onFailure:
                          errors:
                            - AllErrors
                          action:
                            type: MarkAsFailure
                - step:
                    type: HarnessApproval
                    name: Post-Canary Promotion Approval
                    identifier: PostCanary_Promotion_Approval
                    spec:
                      approvalMessage: Promote canary for <+stage.variables.serviceName> in <+stage.variables.envRef> to full rollout?
                      includePipelineExecutionHistory: true
                      isAutoRejectEnabled: false
                      approvers:
                        userGroups:
                          - org._ORG_PROD_DEPLOYERS_
                          - org._ORG_SRE_ONCALL_
                        minimumCount: 1
                        disallowPipelineExecutor: false
                      approverInputs:
                        - name: test
                          defaultValue: this
                    timeout: 1h
                    when:
                      stageStatus: Success
                      condition: <+pipeline.variables.DEPLOY_ENV> == "prd"
                    approvalCriteria:
                      type: Criteria
                      spec:
                        conditions:
                          - type: APPROVAL_CONDITION
                            spec:
                              comparator: EQ
                              fieldName: HarnessApproval
                              value: "true"
                - step:
                    type: K8sCanaryDelete
                    name: Canary Delete
                    identifier: Canary_Delete
                    spec: {}
                    timeout: 2m
                - step:
                    type: K8sRollingDeploy
                    name: Rolling Deployment
                    identifier: Rolling_Deployment
                    spec:
                      skipDryRun: false
                      pruningEnabled: false
                    timeout: 2m
        rollbackSteps: []
    failureStrategies:
      - onFailure:
          errors:
            - AllErrors
          action:
            type: StageRollback
    variables:
      - name: envRef
        type: String
        description: ""
        required: true
        value: <+input>
      - name: serviceName
        type: String
        description: ""
        required: true
        value: <+input>
      - name: appName
        type: String
        description: ""
        required: true
        value: <+input>
      - name: canaryCount
        type: Number
        description: ""
        required: true
        value: <+input>
  identifier: K8s_Canary_Deploy_v2
  versionLabel: v1
