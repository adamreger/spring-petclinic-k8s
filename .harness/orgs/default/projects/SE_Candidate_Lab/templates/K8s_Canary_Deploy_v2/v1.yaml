template:
  name: K8s Canary Deploy v2
  type: Stage
  projectIdentifier: SE_Candidate_Lab
  orgIdentifier: default
  spec:
    type: Deployment
    spec:
      deploymentType: Kubernetes
      service:
        serviceRef: <+stage.variables.serviceName>
      environment:
        environmentRef: <+stage.variables.envRef>
        deployToAll: false
        infrastructureDefinitions:
          - identifier: k8s_infra_<+stage.variables.envRef>
      execution:
        steps:
          - stepGroup:
              name: K8s Canary Deploy
              identifier: K8s_Canary_Deploy
              steps:
                - step:
                    type: HarnessApproval
                    name: Pre-Deploy Approval
                    identifier: PreDeploy_Approval
                    spec:
                      approvalMessage: Approve deploying <+stage.variables.serviceName> to <+stage.variables.envRef>?
                      includePipelineExecutionHistory: true
                      isAutoRejectEnabled: false
                      approvers:
                        userGroups:
                          - org._ORG_PROD_DEPLOYERS_
                          - org._ORG_SRE_ONCALL_
                        minimumCount: 1
                        disallowPipelineExecutor: false
                      approverInputs: []
                    timeout: 1h
                    when:
                      stageStatus: Success
                      condition: <+pipeline.variables.targetEnv> == "prod"
                    approvalCriteria:
                      type: Criteria
                      spec:
                        conditions:
                          - type: APPROVAL_CONDITION
                            spec:
                              comparator: EQ
                              fieldName: HarnessApproval
                              value: "true"
                - step:
                    type: K8sCanaryDeploy
                    name: Canary Deployment
                    identifier: Canary_Deployment
                    spec:
                      skipDryRun: false
                      instanceSelection:
                        type: Count
                        spec:
                          count: <+stage.variables.canaryCount>
                      skipUnchangedManifest: true
                    timeout: 10m
                    failureStrategies:
                      - onFailure:
                          errors:
                            - AllErrors
                          action:
                            type: MarkAsSuccess
                - step:
                    type: Wait
                    name: Observe Canary
                    identifier: Observe_Canary
                    spec:
                      duration: 1m
                - step:
                    type: ShellScript
                    name: Check Canary Health
                    identifier: Check_Canary_Health
                    spec:
                      shell: Bash
                      executionTarget: {}
                      source:
                        type: Inline
                        spec:
                          script: |
                            set -euo pipefail
                            ns="<+infra.namespace>"
                            app="<+stage.variables.appName>"
                            echo "Checking rollout for ${app}-canary in ${ns}..."
                            status=0
                            if ! kubectl rollout status "deployment/${app}-canary" --namespace "${ns}" --timeout=180s; then
                              status=$?
                              echo "Canary deployment did not become ready within timeout (exit ${status})."
                            fi

                            echo "Listing canary pods for quick inspection:"
                            kubectl get pods --namespace "${ns}" -l harness.io/canary=true -o wide || true

                            echo "Fetching recent logs from canary pod(s) for diagnostics..."
                            mapfile -t pods < <(kubectl get pods --namespace "${ns}" -l harness.io/canary=true -o name)
                            if [ ${#pods[@]} -eq 0 ]; then
                              echo "No canary pods found to fetch logs from."
                            else
                              for pod in "${pods[@]}"; do
                                echo "----- Logs for ${pod} -----"
                                kubectl logs --namespace "${ns}" "${pod}" --tail=200 || true
                                echo "----- End logs for ${pod} -----"
                              done
                            fi
                            exit ${status}
                      environmentVariables: []
                      outputVariables: []
                    timeout: 10m
                - step:
                    type: K8sCanaryDelete
                    name: Canary Delete
                    identifier: Canary_Delete
                    spec: {}
                    timeout: 10m
                - step:
                    type: K8sRollingDeploy
                    name: Rolling Deployment
                    identifier: Rolling_Deployment
                    spec:
                      skipDryRun: false
                      pruningEnabled: false
                    timeout: 10m
        rollbackSteps: []
    failureStrategies:
      - onFailure:
          errors:
            - AllErrors
          action:
            type: StageRollback
    variables:
      - name: envRef
        type: String
        description: ""
        required: true
        value: <+input>
      - name: serviceName
        type: String
        description: ""
        required: true
        value: <+input>
      - name: appName
        type: String
        description: ""
        required: true
        value: <+input>
      - name: canaryCount
        type: Number
        description: ""
        required: true
        value: <+input>
  identifier: K8s_Canary_Deploy_v2
  versionLabel: v1
